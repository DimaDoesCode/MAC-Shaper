#!/bin/sh /etc/rc.common
# /etc/init.d/mac-shaper
# adapted to procd init scripts style

START=95
STOP=05
USE_PROCD=1

BIN="/usr/bin/mac-shaper"
NAME="mac-shaper"
DESC="MAC traffic shaper"
CONFIG="mac-shaper"    # config name in /etc/config/mac-shaper

EXTRA_COMMANDS="configured"
EXTRA_HELP="        configured      Check if service is configured"

configured() {
    # Detect active shaping on br-lan using tc
    if /sbin/tc qdisc show dev br-lan | grep -q "qdisc htb"; then
        ACTIVE=1
    else
        ACTIVE=0
    fi

    echo "{ \"active\": $ACTIVE }"
}

# Optional: short description shown by some tools
service_description() {
    echo "$DESC"
}

start_service() {
    if [ ! -x "$BIN" ]; then
        logger -t $NAME "ERROR: $BIN not found or not executable"
        return 1
    fi

    # small wait to ensure network interfaces are up
    sleep 1

    procd_open_instance
    # run the binary with the 'start' subcommand; procd will supervise it
    procd_set_param command $BIN start
    # restart automatically if it crashes
    #procd_set_param respawn
    # forward stdout/stderr to logd (view via `logread`)
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
    logger -t $NAME "start_service executed"
}

stop_service() {
    # prefer graceful stop via the binary's control command
    if [ -x "$BIN" ]; then
        $BIN stop >> /dev/null 2>&1 || true
    else
        logger -t $NAME "stop: binary missing"
    fi
    # procd will ensure the supervised process is killed if still running
    logger -t $NAME "stop_service executed"
}

reload_service() {
    if [ -x "$BIN" ]; then
        $BIN reload >> /dev/null 2>&1 || {
            logger -t $NAME "reload failed"
            return 1
        }
    else
        logger -t $NAME "reload: binary missing"
        return 1
    fi
    logger -t $NAME "reload_service executed"
}

restart_service() {
    # if your binary implements restart, prefer that; otherwise rely on procd
    if [ -x "$BIN" ]; then
        $BIN restart >> /dev/null 2>&1 || {
            # fallback to procd-managed restart
            procd_restart_service $NAME || {
                stop_service
                start_service
            }
        }
    else
        procd_restart_service $NAME || true
    fi
    logger -t $NAME "restart_service executed"
}

service_triggers() {
    procd_add_reload_trigger "$CONFIG"
    logger -t $NAME "service_triggers executed"
}

status() {
    if [ -x "$BIN" ]; then
        $BIN status
    else
        echo "$NAME: binary missing"
        return 3
    fi
    logger -t $NAME "status executed"
}